# 一、数据库设计

`create database hotel_system`

## 1.核心实体表设计
*这些 SQL 语句包含了文档中要求的 18位身份证校验、性别默认值、价格非负约束等功能 。*

### (1)用户表 (包含VIP等级与积分)
```
CREATE TABLE users (
    user_id SERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash TEXT NOT NULL,
    real_name VARCHAR(50) NOT NULL,
    phone VARCHAR(20),
    points INT DEFAULT 0, -- 用户积分 
    is_vip BOOLEAN DEFAULT FALSE, -- 积分多可升级VIP 
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### (2)酒店表
```
CREATE TABLE hotels (
    hotel_id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    city VARCHAR(50) NOT NULL, -- 城市名查询 
    district VARCHAR(50) NOT NULL, -- 区域名查询 
    address TEXT,
    description TEXT
);
```

### (3)客房表
```
CREATE TABLE rooms (
    room_id SERIAL PRIMARY KEY,
    hotel_id INT REFERENCES hotels(hotel_id),
    room_type VARCHAR(50) NOT NULL, -- 非空约束 
    price DECIMAL(10, 2) NOT NULL DEFAULT 0.0, -- 货币类型缺省值 
    capacity INT DEFAULT 2, -- 一间房可入住多人 
    total_inventory INT NOT NULL, -- 总房间数
    available_inventory INT NOT NULL, -- 当前剩余可预订数
    CHECK (price >= 0)
);
```

### (4)订单表
```
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INT REFERENCES users(user_id),
    hotel_id INT REFERENCES hotels(hotel_id),
    room_type VARCHAR(50),
    total_price DECIMAL(10, 2) DEFAULT 0.0,
    status VARCHAR(20) DEFAULT 'booked', -- booked, stayed, cancelled 
    check_in_date DATE NOT NULL DEFAULT CURRENT_DATE, -- 缺省日期 
    check_out_date DATE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_dates CHECK (check_out_date > check_in_date) -- 离店不小于入住时间 
);
```

### (5)入住人明细表 (支持一次预定多间，多人入住)
```
CREATE TABLE order_guests (
    guest_id SERIAL PRIMARY KEY,
    order_id INT REFERENCES orders(order_id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,
    gender CHAR(1) DEFAULT 'M', -- 性别缺省 
    id_card CHAR(18) NOT NULL, -- 规则：必须18位 
    age INT,
    occupation VARCHAR(50), -- 职业，用于统计 
    income_level VARCHAR(20), -- 收入状况 
    education VARCHAR(50), -- 教育程度 
    CONSTRAINT check_id_len CHECK (length(id_card) = 18) -- 实施规则 
);
```

## 2.视图与触发器
### (1)酒店客房信息视图
*满足“查看某城市某区域酒店时，显示所有客房详细信息”的要求 。*
```
CREATE VIEW view_hotel_rooms AS
SELECT 
    h.city, h.district, h.name AS hotel_name, 
    r.room_type, r.price, r.available_inventory, r.capacity
FROM hotels h
JOIN rooms r ON h.hotel_id = r.hotel_id;
```

### (2)预订自动扣减库存触发器
*当订单状态变为 'booked' 时，自动减少 rooms 表中的可用数量 。*
```
CREATE OR REPLACE FUNCTION update_room_inventory()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT') THEN
        UPDATE rooms SET available_inventory = available_inventory - 1
        WHERE hotel_id = NEW.hotel_id AND room_type = NEW.room_type;
    ELSIF (NEW.status = 'cancelled' AND OLD.status != 'cancelled') THEN
        UPDATE rooms SET available_inventory = available_inventory + 1
        WHERE hotel_id = NEW.hotel_id AND room_type = NEW.room_type;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER trg_after_booking
AFTER INSERT OR UPDATE ON orders
FOR EACH ROW EXECUTE FUNCTION update_room_inventory();
```

## 3.索引优化 (提高查询性能)
- 城市与区域索引: CREATE INDEX idx_hotel_location ON hotels(city, district); (针对频繁的地域搜索)
- 订单日期索引: CREATE INDEX idx_order_date ON orders(check_in_date); (针对汇总统计)

# 二、构建Go后端
我们将使用 Gin（高性能 Web 框架）和 GORM（对象关系映射工具）。GORM 能让我们像操作对象一样操作数据库，非常适合处理文档中要求的复杂逻辑。

## 1.初始化项目
*在backend目录下执行：*
```
go mod init hotel-system
go get -u github.com/gin-gonic/gin
go get -u gorm.io/gorm
go get -u gorm.io/driver/postgres
```

## 2.目录结构
```
/backend
  ├── main.go          # 程序入口
  ├── config/          # 数据库连接配置
  ├── models/          # 数据库模型 (与表对应) 
  ├── controllers/     # 业务逻辑处理 (API 接口)
  └── routes/          # 路由定义
```

## 3.连接PostgreSQL(config/db.go)
```
package config

import (
    "gorm.io/driver/postgres"
    "gorm.io/gorm"
    "log"
)

var DB *gorm.DB

func ConnectDatabase() {
    dsn := "host=localhost user=postgres password=你的密码 dbname=hotel_db port=5432 sslmode=disable"
    database, err := gorm.Open(postgres.Open(dsn), &gorm.Config{})

    if err != nil {
        log.Fatal("Failed to connect to database!", err)
    }

    DB = database
}
```

## 4.定义模型(models/user.go)
我们需要在 Go 中定义与数据库对应的结构。根据文档要求，用户信息需要维护，且包含积分和 VIP 逻辑 。
```
package models

import "time"

type User struct {
    UserID       uint      `gorm:"primaryKey;autoIncrement" json:"user_id"`
    Username     string    `gorm:"unique;not null" json:"username"`
    PasswordHash string    `gorm:"not null" json:"-"` // 密码不返回给前端
    RealName     string    `json:"real_name"`
    Points       int       `gorm:"default:0" json:"points"`
    IsVip        bool      `gorm:"default:false" json:"is_vip"`
    CreatedAt    time.Time `json:"created_at"`
}
```

## 5.编写用户注册逻辑(controllers/user.go)
*必须注册用户，合法用户才可以预定酒店 。*
```
package controllers

import (
    "hotel-system/config"
    "hotel-system/models"
    "net/http"
    "github.com/gin-gonic/gin"
)

func Register(c *gin.Context) {
    var input struct {
        Username string `json:"username" binding:"required"`
        Password string `json:"password" binding:"required"`
        RealName string `json:"real_name" binding:"required"`
    }

    // 1. 验证输入格式 
    if err := c.ShouldBindJSON(&input); err != nil {
        c.JSON(http.StatusBadRequest, gin.H{"error": "输入数据不合法"})
        return
    }

    // 2. 创建用户对象
    user := models.User{
        Username:     input.Username,
        PasswordHash: input.Password, // 实际开发建议用 bcrypt 加密
        RealName:     input.RealName,
    }

    // 3. 写入数据库
    if err := config.DB.Create(&user).Error; err != nil {
        c.JSON(http.StatusInternalServerError, gin.H{"error": "注册失败，用户名可能已存在"})
        return
    }

    c.JSON(http.StatusOK, gin.H{"message": "注册成功", "data": user})
}
```